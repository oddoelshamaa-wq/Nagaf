<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مطعم نجف - Nagaf</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #1a237e; --dark-blue: #0d1b6e; --red: #b71c1c; --white: #ffffff; --bg-gray: #f4f6f8; --text: #333; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Cairo', sans-serif; margin: 0; background: var(--bg-gray); padding-bottom: 0; overflow-x: hidden; }
        
        /* --- LOADER STYLES --- */
        #loader-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 99999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }
        .loader-content { position: relative; width: 150px; height: 150px; display: flex; justify-content: center; align-items: center; }
        .loader-logo { 
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover; 
            border: 4px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.1); 
            animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite; 
        }
        .loader-spinner {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 3px solid transparent; border-top-color: var(--blue); border-bottom-color: var(--red);
            border-radius: 50%; animation: spin 1s linear infinite; z-index: 1;
        }
        .loader-text { 
            margin-top: 20px; font-size: 2rem; font-weight: 900; color: var(--blue); 
            letter-spacing: 5px; text-transform: uppercase;
            animation: shake 2s infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes glitch { 
            0% { transform: translate(0) } 
            20% { transform: translate(-2px, 2px) } 
            40% { transform: translate(-2px, -2px) } 
            60% { transform: translate(2px, 2px) } 
            80% { transform: translate(2px, -2px) } 
            100% { transform: translate(0) }
        }
        @keyframes shake {
            0% { transform: skewX(-10deg); }
            5% { transform: skewX(10deg); }
            10% { transform: skewX(-10deg); }
            15% { transform: skewX(10deg); }
            20% { transform: skewX(0deg); }
            100% { transform: skewX(0deg); }
        }
        .hide-loader { opacity: 0; visibility: hidden; }

        /* General UI */
        header { background: linear-gradient(135deg, #1a237e 0%, #283593 100%); color: var(--white); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); height: 70px; }
        .logo-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid white; object-fit: cover; background: white; }
        .user-controls { display: flex; gap: 15px; align-items: center; }
        .icon-wrap { position: relative; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .badge { position: absolute; top: 0; right: 0; background: var(--red); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid var(--blue); }
        .profile-btn { background: rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); }
        .hero { background: linear-gradient(rgba(26, 35, 126, 0.8), rgba(183, 28, 28, 0.6)), url('https://source.unsplash.com/800x600/?egyptian-food') center/cover; height: 160px; display: flex; align-items: center; justify-content: center; text-align: center; color: white; border-radius: 0 0 25px 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .category-nav { display: flex; overflow-x: auto; padding: 5px 15px 15px; gap: 10px; scrollbar-width: none; }
        .cat-btn { background: white; color: var(--text); border: 1px solid #e0e0e0; padding: 8px 20px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; cursor: pointer; flex-shrink: 0; transition: 0.3s; }
        .cat-btn.active { background: var(--blue); color: white; border-color: var(--blue); }
        .container { padding: 0 15px; max-width: 800px; margin: 0 auto; min-height: 50vh; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        .card img { width: 100%; height: 130px; object-fit: cover; }
        .card-body { padding: 12px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .price-tag { font-size: 0.9rem; color: var(--red); font-weight: 700; margin-bottom: 10px; }
        .btn-add { background: var(--blue); color: white; border: none; padding: 8px; width: 100%; border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-weight: bold; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2500; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 380px; position: relative; animation: popUp 0.3s ease; }
        @keyframes popUp { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        .close-btn { position: absolute; top: 15px; left: 15px; font-size: 1.5rem; color: #aaa; cursor: pointer; }
        .custom-input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: 'Cairo'; background: #fafafa; font-size: 1rem; }
        .btn-main { background: var(--blue); color: white; width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-gps { background: #27ae60; color: white; width: 100%; padding: 10px; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 700; cursor: pointer; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-gps.loading { background: #95a5a6; cursor: not-allowed; animation: pulse 1s infinite; }
        .gps-hint { font-size: 0.75rem; color: #666; margin-top: -10px; margin-bottom: 12px; display: block; text-align: center; }
        .btn-danger { background: var(--red); color: white; padding:10px; width:100%; border:none; border-radius:10px; font-weight: 700; margin-top:5px; }
        footer { background-color: var(--dark-blue); color: white; text-align: center; padding: 25px 0 30px 0; margin-top: 40px; border-top: 4px solid var(--red); }
        .footer-hotline { font-size: 2rem; font-weight: 800; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .footer-icons { display: flex; justify-content: center; gap: 25px; margin-bottom: 15px; }
        .footer-icons a { color: white; font-size: 2rem; }
        .chat-float { position: fixed; bottom: 30px; left: 20px; background: var(--red); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.6rem; z-index: 2000; cursor: pointer; border: 2px solid white; transition: 0.3s; }
        .chat-float.new-msg { animation: pulse 1s infinite; box-shadow: 0 0 15px red; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .chat-window { display: none; position: fixed; bottom: 100px; left: 20px; width: 300px; height: 400px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.15); z-index: 2000; flex-direction: column; overflow: hidden; border: 1px solid #eee; }
        .option-item { padding: 15px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; transition: 0.2s; }
        .option-item.selected { border: 2px solid var(--blue); background: #f0f7ff; }
        .cancel-btn { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; cursor: pointer; margin-top: 5px; width: 100%; }
        .item-note-input { width: 100%; border: 1px solid #ccc; border-radius: 8px; padding: 10px; font-family: 'Cairo'; margin-bottom: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loader-wrapper">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <img src="logo.jpg.jpg" class="loader-logo" alt="Nagaf Logo">
        </div>
        <div class="loader-text">N A G A F</div>
    </div>

    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3"></audio>

    <header>
        <div class="user-controls">
            <div class="icon-wrap" onclick="openCart()"><i class="fas fa-shopping-basket"></i><span class="badge" id="cartCount">0</span></div>
            <div class="icon-wrap" onclick="openMyOrders()"><i class="fas fa-receipt"></i></div>
            <div id="loginBtnNav" class="profile-btn" onclick="openAuth()"><i class="fas fa-sign-in-alt"></i></div>
            <div id="userProfileNav" class="profile-btn" style="display:none;" onclick="openProfile()"><i class="fas fa-user"></i></div>
        </div>
        <div class="logo-container"><img src="logo.jpg.jpg" alt="Nagaf" class="logo-img"></div>
    </header>

    <div class="hero"><div><h1>أصل الأكل المصري</h1><p>أطلب واستمتع بالطعم الأصلي</p></div></div>
    
    <div class="category-nav" id="categoryNav"></div>
    <div class="container"><div class="grid" id="productGrid"></div></div>
    
    <footer>
        <div class="footer-hotline"><i class="fas fa-headset"></i> 19971</div>
        <div class="footer-icons">
            <a href="https://wa.me/201119008397" target="_blank"><i class="fab fa-whatsapp"></i></a>
            <a href="https://www.facebook.com/NagafRestaurants/" target="_blank"><i class="fab fa-facebook-f"></i></a>
        </div>
        <div class="footer-copy">نجف | 1958</div>
    </footer>
    
    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('authModal')">&times;</span>
            <div id="regFields">
                <h2 style="text-align:center;color:var(--blue);">تسجيل جديد</h2>
                <input type="text" id="regName" class="custom-input" placeholder="الاسم">
                <input type="tel" id="regPhone" class="custom-input" placeholder="رقم الهاتف (مثال: 01xxxxxxxxx)">
                <select id="regZone" class="custom-input">
                    <option value="" disabled selected>اختر المنطقة</option>
                    <option value="المعادي">المعادي</option>
                    <option value="مدينة نصر">مدينة نصر</option>
                    <option value="مصر الجديدة">مصر الجديدة</option>
                    <option value="وسط البلد">وسط البلد</option>
                    <option value="الهرم">الهرم</option>
                    <option value="أخرى">منطقة أخرى</option>
                </select>

                <button id="gpsBtn" class="btn-gps" onclick="getUserLocation()">
                    <i class="fas fa-map-marker-alt"></i> <span id="gpsTxt">تحديد العنوان بالـ GPS</span>
                </button>
                <span class="gps-hint">* يمكنك تعديل العنوان يدوياً إذا لم يكن دقيقاً</span>

                <input type="text" id="regAddress" class="custom-input" placeholder="رقم العمارة والشارع">
                
                <div id="recaptcha-container"></div>
                <button class="btn-main" id="sendOtpBtn" onclick="handleRegister()">حفظ البيانات والتحقق</button>
            </div>

            <!-- OTP Field -->
            <div id="otpFields" style="display:none;">
                <h2 style="text-align:center;color:var(--blue);">تحقق من الهاتف</h2>
                <p style="text-align:center;font-size:0.9rem;">أدخل الرمز المرسل لهاتفك</p>
                <input type="number" id="otpCode" class="custom-input" placeholder="------" style="text-align:center;letter-spacing:10px;font-size:1.5rem;">
                <button class="btn-main" onclick="verifyOTP()">تأكيد الكود</button>
                <button class="btn-danger" onclick="location.reload()" style="background:#888;">رجوع</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="profileModal"><div class="modal-content" style="text-align:center;"><span class="close-btn" onclick="closeModal('profileModal')">&times;</span><div style="width:80px;height:80px;background:#f0f0f0;border-radius:50%;margin:0 auto 15px;display:flex;align-items:center;justify-content:center;font-size:2.5rem;color:var(--blue);"><i class="fas fa-user-circle"></i></div><h3 id="profName" style="margin:5px 0;"></h3><p id="profPhone" style="color:#666;margin:5px 0;"></p><p id="profAddress" style="color:#666;font-size:0.9rem;margin-bottom:20px;"></p><button class="btn-danger" onclick="logout()">تسجيل الخروج</button></div></div>
    
    <div class="modal" id="successModal"><div class="modal-content" style="text-align:center;"><i class="fas fa-check-circle" style="font-size:4rem;color:#27ae60;margin-bottom:15px;display:block;"></i><h3 style="color:var(--blue);margin:10px 0;">تم الإرسال بنجاح!</h3><p style="color:#555;font-size:1.1rem;">سيتم مراجعة النطاق الجغرافي وتأكيد الطلب.</p><button class="btn-main" onclick="closeSuccessModal()">حسناً</button></div></div>
    
    <div class="modal" id="optionsModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('optionsModal')">&times;</span>
            <h3 id="optProdName" style="color:var(--blue);text-align:center;margin-top:0;"></h3>
            <div id="variantsList" style="margin:15px 0;max-height:200px;overflow-y:auto;"></div>
            <label style="font-weight:bold;display:block;margin-bottom:5px;">ملاحظات خاصة:</label>
            <input type="text" id="itemNote" class="item-note-input" placeholder="مثال: بدون بصل، زيادة طحينة...">
            <h4 style="text-align:center;margin:10px 0;">السعر: <span id="selectedPrice" style="color:var(--red);font-size:1.2rem;">0</span> ج</h4>
            <button class="btn-main" onclick="confirmAddToCart()">أضف للسلة</button>
        </div>
    </div>
    
    <div class="modal" id="cartModal"><div class="modal-content"><span class="close-btn" onclick="closeModal('cartModal')">&times;</span><h2 style="color:var(--blue);text-align:center;border-bottom:1px solid #eee;padding-bottom:10px;">سلة المشتريات</h2><div id="cartItems" style="max-height:300px;overflow-y:auto;margin-bottom:15px;"></div><div style="display:flex;justify-content:space-between;font-weight:bold;font-size:1.1rem;margin-bottom:15px;"><span>الإجمالي:</span><span style="color:var(--red);"><span id="cartTotal">0</span> جنيه</span></div><button class="btn-main" onclick="submitOrder()">تأكيد الطلب</button></div></div>
    
    <div class="modal" id="ordersModal"><div class="modal-content"><span class="close-btn" onclick="closeModal('ordersModal')">&times;</span><h2 style="text-align:center;color:var(--blue);">طلباتي السابقة</h2><div id="ordersList" style="max-height:60vh;overflow-y:auto;background:#f9f9f9;padding:10px;border-radius:10px;"></div></div></div>
    
    <div class="chat-float" id="chatFloat" onclick="toggleChat()"><i class="fas fa-headset"></i></div>
    <div class="chat-window" id="chatWindow"><div style="background:var(--blue);color:white;padding:12px;display:flex;justify-content:space-between;"><span style="font-weight:bold;">خدمة العملاء</span><span onclick="toggleChat()" style="cursor:pointer;">✖</span></div><div id="chatBody" style="flex:1;padding:10px;overflow-y:auto;background:#f9f9f9;display:flex;flex-direction:column;gap:8px;"></div><div style="padding:10px;border-top:1px solid #ddd;display:flex;"><input type="text" id="chatInput" placeholder="اكتب..." style="width:100%;padding:8px;border:1px solid #ccc;border-radius:20px;margin-left:5px;"><button onclick="sendChat()" style="background:var(--blue);color:white;border:none;width:35px;height:35px;border-radius:50%;"><i class="fas fa-paper-plane"></i></button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyDi0582RlkH0GTFK6GIiLqZZOJn-zRi5vs",
          authDomain: "nagaf-e2810.firebaseapp.com",
          databaseURL: "https://nagaf-e2810-default-rtdb.firebaseio.com",
          projectId: "nagaf-e2810",
          storageBucket: "nagaf-e2810.firebasestorage.app",
          messagingSenderId: "1049815841886",
          appId: "1:1049815841886:web:a27ca703b985a4645bc8cf",
          measurementId: "G-QS18B2N7EZ"
        };
        const app = initializeApp(firebaseConfig); 
        const db = getDatabase(app);
        const auth = getAuth(app);
        auth.languageCode = 'ar';

        window.addEventListener('load', function() {
            const loader = document.getElementById('loader-wrapper');
            setTimeout(() => {
                loader.classList.add('hide-loader');
                setTimeout(() => { loader.style.display = 'none'; }, 800);
            }, 2500); 
        });

        let cart=[], currentUser=JSON.parse(localStorage.getItem('nagaf_user_info')), products=[], selectedProductTemp=null, selectedVariantTemp=null, tempCoords=null, confirmationResult=null;

        onValue(ref(db, 'products'), (s) => { products=Object.values(s.val()||{}); loadProducts('all'); });
        onValue(ref(db, 'categories'), (s) => { 
            const nav=document.getElementById('categoryNav'); nav.innerHTML='<button class="cat-btn active" onclick="window.filterCat(\'all\',this)">الكل</button>';
            Object.values(s.val()||{}).forEach(c=>nav.innerHTML+=`<button class="cat-btn" onclick="window.filterCat('${c.name}',this)">${c.name}</button>`);
        });

        window.filterCat = function(c,b) { document.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); loadProducts(c); }
        window.loadProducts = function(c) {
            const g=document.getElementById('productGrid'); g.innerHTML='';
            products.forEach(p=>{
                if((c==='all'||p.cat===c)&&p.available){
                    const minPrice = p.variants?Math.min(...p.variants.map(v=>v.price)):0;
                    g.innerHTML+=`<div class="card" onclick="window.openOptions('${p.name}')"><img src="${p.img}" alt="${p.name}"><div class="card-body"><h3>${p.name}</h3><div class="price-tag">يبدأ من ${minPrice} ج</div><button class="btn-add">أضف للسلة</button></div></div>`;
                }
            });
        }

        // --- GPS Logic ---
        window.getUserLocation = function() {
            const btn = document.getElementById('gpsBtn'), txt = document.getElementById('gpsTxt'), addrInput = document.getElementById('regAddress');
            if (!navigator.geolocation) return alert("متصفحك لا يدعم تحديد الموقع.");
            btn.classList.add('loading'); txt.innerText = "جاري التحديد...";
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude;
                tempCoords = { lat, lng: lon };
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=ar`);
                    const data = await res.json();
                    if (data && data.address) {
                        const a = data.address;
                        const building = a.house_number || "";
                        const road = a.road || "";
                        const suburb = a.suburb || a.city_district || "";
                        addrInput.value = `${building ? 'عمارة '+building+'، ' : ''}${road}${suburb ? '، '+suburb : ''}`;
                        txt.innerText = "تم التحديد ✅";
                        btn.style.background = "#27ae60";
                    }
                } catch (e) { txt.innerText = "تم التحديد (إحداثيات فقط)"; }
                btn.classList.remove('loading');
            }, () => { btn.classList.remove('loading'); alert("تأكد من تفعيل الـ GPS"); }, { enableHighAccuracy: true, timeout: 10000 });
        };

        if(currentUser) { setupUserUI(); initChatListener(); }
        window.openAuth=()=>document.getElementById('authModal').style.display='flex';
        window.openProfile=()=>{ if(!currentUser){openAuth();return;} document.getElementById('profName').innerText=currentUser.name; document.getElementById('profPhone').innerText=currentUser.phone; document.getElementById('profAddress').innerText=currentUser.address; document.getElementById('profileModal').style.display='flex'; }
        window.closeModal=function(id){document.getElementById(id).style.display='none';}
        window.logout=()=>{ localStorage.removeItem('nagaf_user_info'); location.reload(); }
        
        // --- OTP & Registration Logic ---
        window.handleRegister=()=>{
            let n=document.getElementById('regName').value, 
                p=document.getElementById('regPhone').value, 
                z=document.getElementById('regZone').value, 
                a=document.getElementById('regAddress').value;

            if(n&&p&&z&&a){
                // تحويل الرقم للصيغة الدولية (افتراض مصر +20)
                let formattedPhone = p.startsWith('+') ? p : '+20' + p.replace(/^0/, '');
                
                document.getElementById('sendOtpBtn').innerText = "جاري الإرسال...";
                
                if(!window.recaptchaVerifier){
                    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });
                }

                signInWithPhoneNumber(auth, formattedPhone, window.recaptchaVerifier)
                    .then((result) => {
                        confirmationResult = result;
                        document.getElementById('regFields').style.display = 'none';
                        document.getElementById('otpFields').style.display = 'block';
                    }).catch((error) => {
                        alert("خطأ في إرسال الكود: " + error.message);
                        document.getElementById('sendOtpBtn').innerText = "حفظ البيانات والتحقق";
                    });
            } else alert('يرجى إكمال جميع البيانات');
        }

        window.verifyOTP = () => {
            let code = document.getElementById('otpCode').value;
            if(!code) return alert("أدخل الكود أولاً");

            confirmationResult.confirm(code).then((result) => {
                // النجاح - حفظ البيانات النهائية
                let n=document.getElementById('regName').value, 
                    p=document.getElementById('regPhone').value, 
                    z=document.getElementById('regZone').value, 
                    a=document.getElementById('regAddress').value;

                currentUser={name:n,phone:p,address:`${z} - ${a}`,zone:z, coords: tempCoords, uid: result.user.uid}; 
                localStorage.setItem('nagaf_user_info',JSON.stringify(currentUser)); 
                push(ref(db,'users'),{...currentUser,role:'customer'}); 
                setupUserUI(); 
                closeModal('authModal'); 
                initChatListener();
                alert("تم التحقق بنجاح!");
            }).catch((error) => {
                alert("الكود غير صحيح، حاول مرة أخرى.");
            });
        }
        
        function setupUserUI(){ document.getElementById('loginBtnNav').style.display='none'; document.getElementById('userProfileNav').style.display='flex'; }

        window.openOptions=function(n){
            selectedProductTemp=products.find(p=>p.name===n); 
            document.getElementById('optProdName').innerText=n;
            const l=document.getElementById('variantsList'); l.innerHTML='';
            selectedProductTemp.variants.forEach((v,i)=>{
                l.innerHTML+=`<div class="option-item" onclick="selectVar(${i},this)"><div class="option-details"><b>${v.bread}${v.size && v.size !== 'موحد' ? ' ('+v.size+')' : ''}</b></div><div style="font-weight:bold;color:var(--red)">${v.price} ج</div></div>`;
            });
            if(l.children[0]) window.selectVar(0,l.children[0]);
            document.getElementById('itemNote').value = '';
            document.getElementById('optionsModal').style.display='flex';
        }

        window.selectVar=function(i,el){ 
            document.querySelectorAll('.option-item').forEach(x=>x.classList.remove('selected')); el.classList.add('selected');
            selectedVariantTemp=selectedProductTemp.variants[i]; document.getElementById('selectedPrice').innerText=selectedVariantTemp.price; 
        }

        window.confirmAddToCart=function(){ 
            cart.push({ ...selectedProductTemp, variant: selectedVariantTemp, note: document.getElementById('itemNote').value }); 
            updateCart(); closeModal('optionsModal'); 
        }

        function updateCart(){ 
            document.getElementById('cartCount').innerText=cart.length; 
            const d=document.getElementById('cartItems'); 
            let t=0; 
            d.innerHTML=cart.map((i,x)=>{
                t+=i.variant.price; 
                return `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
                    <div><b>${i.name}</b><br><small>${i.variant.bread}</small>${i.note ? '<br><small style="color:#e67e22;">'+i.note+'</small>' : ''}</div>
                    <div>${i.variant.price}ج <i class="fas fa-trash" style="color:red;cursor:pointer;margin-right:5px;" onclick="window.remItem(${x})"></i></div>
                </div>`
            }).join(''); 
            document.getElementById('cartTotal').innerText=t; 
        }

        window.remItem=function(i){ cart.splice(i,1); updateCart(); }
        window.openCart=function(){ document.getElementById('cartModal').style.display='flex'; }
        
        window.submitOrder=function(){
            if(!currentUser) return openAuth();
            if(!cart.length) return alert('السلة فارغة');
            push(ref(db,'orders'),{
                customerName:currentUser.name,
                phone:currentUser.phone,
                address:currentUser.address,
                googleMaps: currentUser.coords ? `https://www.google.com/maps?q=${currentUser.coords.lat},${currentUser.coords.lng}` : "غير متوفر",
                items:cart,
                total:parseInt(document.getElementById('cartTotal').innerText),
                status:'pending',
                timestamp:Date.now()
            }).then(()=>{ closeModal('cartModal'); cart=[]; updateCart(); document.getElementById('successModal').style.display='flex'; });
        }
        window.closeSuccessModal=()=>{ document.getElementById('successModal').style.display='none'; window.openMyOrders(); }
        
        window.openMyOrders=function(){
            if(!currentUser) return openAuth();
            onValue(ref(db,'orders'),(s)=>{
                const d=s.val()||{}, l=document.getElementById('ordersList'); l.innerHTML='';
                const mo=Object.keys(d).map(k=>({...d[k], key:k})).filter(o=>o.phone===currentUser.phone).reverse();
                mo.forEach(o=>{ 
                    let st = o.status==='pending' ? 'جاري المراجعة...' : (o.status==='processing'?'جاري التحضير':(o.status==='completed'?'مكتمل':'ملغي'));
                    l.innerHTML+=`<div style="background:white;padding:10px;margin-bottom:10px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                        <b>${o.total} ج</b> - <span style="color:${o.status==='completed'?'green':'orange'}">${st}</span>
                        <br><small>${new Date(o.timestamp).toLocaleString('ar-EG')}</small>
                        ${(o.status!=='completed'&&o.status!=='cancelled') ? (o.cancelRequest ? '<br><small>طلب الإلغاء قيد الانتظار</small>' : '<button class="cancel-btn" onclick="window.requestCancel(\''+o.key+'\')">إلغاء الطلب</button>') : ''}
                    </div>`; 
                });
                document.getElementById('ordersModal').style.display='flex';
            });
        }

        window.requestCancel = (k) => {
            let r = prompt("سبب الإلغاء؟");
            if(r) update(ref(db, 'orders/'+k), { cancelRequest: true, cancelReason: r }).then(()=>alert("تم إرسال الطلب"));
        }

        let chatInitialized = false;
        function initChatListener() {
            if(!currentUser) return;
            onValue(ref(db,'chats/'+currentUser.phone), (s) => {
                const msgs = Object.values(s.val()||{});
                const chatBody = document.getElementById('chatBody');
                chatBody.innerHTML = msgs.map(m=>`<div style="align-self:${m.sender==='customer'?'flex-start':'flex-end'};background:${m.sender==='customer'?'var(--blue)':'#ddd'};color:${m.sender==='customer'?'white':'black'};padding:8px 12px;border-radius:12px;margin:2px;max-width:85%;">${m.text}</div>`).join('');
                chatBody.scrollTop = chatBody.scrollHeight;
                if(chatInitialized) {
                    const last = msgs[msgs.length-1];
                    if(last && last.sender === 'admin' && Date.now() - last.timestamp < 10000) {
                        document.getElementById('msgSound').play().catch(()=>{});
                        document.getElementById('chatFloat').classList.add('new-msg');
                    }
                } else chatInitialized = true;
            });
        }

        window.toggleChat=()=>{ 
            const w=document.getElementById('chatWindow'); w.style.display=w.style.display==='none'?'flex':'none'; 
            document.getElementById('chatFloat').classList.remove('new-msg'); 
        }
        window.sendChat=()=>{ 
            let t=document.getElementById('chatInput').value; 
            if(t&&currentUser){ push(ref(db,'chats/'+currentUser.phone),{sender:'customer',text:t, timestamp:Date.now()}); document.getElementById('chatInput').value=''; }
        }
    </script>
</body>  
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم نجف - المطور</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --blue: #18248b; --red: #8c0104; --white: #ffffff; --green: #27ae60; --gray: #f0f2f5; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; background: var(--gray); height: 100vh; overflow: hidden; }

        /* Login */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--blue); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; }
        #loginScreen input { padding: 12px; width: 280px; margin: 10px; border-radius: 5px; border: none; font-size: 1rem; }
        #loginScreen button { padding: 12px 40px; background: var(--red); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--blue); color: white; padding: 20px 10px; display: flex; flex-direction: column; border-left: 5px solid var(--red); }
        .menu-item { padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 5px; display: flex; align-items: center; gap: 10px; transition: 0.3s; position: relative; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-right: 4px solid var(--red); }
        
        /* Notification Counter */
        .badge-counter { background: var(--red); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.75rem; position: absolute; left: 15px; display: none; font-weight: bold; box-shadow: 0 0 5px white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* General UI */
        .form-box { background: white; padding: 25px; border-radius: 10px; max-width: 900px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .users-table { width: 100%; border-collapse: collapse; background: white; margin-top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .users-table thead tr { background-color: #1a237e; color: white; }
        .users-table th, .users-table td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        
        .btn-blue { background: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-red { background: #b71c1c; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-warning { background: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 5px; }

        /* Order Cards */
        .order-card { background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 5px solid var(--blue); cursor: pointer; position: relative; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .order-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .cancel-requested { border-left-color: orange !important; background-color: #fff8e1; animation: flashOrange 1.5s infinite alternate; }
        @keyframes flashOrange { from { box-shadow: 0 0 5px orange; } to { box-shadow: 0 0 15px orange; } }
        .cancel-badge { background: var(--red); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; position: absolute; top: 10px; left: 10px; z-index: 10; }

        /* ========================================= */
        /*        MODERN TEAM CHAT STYLES            */
        /* ========================================= */
        .team-chat-container {
            display: flex;
            flex-direction: column;
            height: 75vh;
            background: #e5ddd5;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }

        .team-chat-msgs {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .team-msg {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 75%;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }

        .team-msg.mine {
            background: #dcf8c6;
            align-self: flex-end;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 0;
            color: #333;
        }
        .team-msg.mine::after {
            content: ""; position: absolute; bottom: 0; right: -10px; width: 20px; height: 20px;
            background: radial-gradient(circle at top left, transparent, transparent 10px, #dcf8c6 10px);
        }

        .team-msg.others {
            background: white;
            align-self: flex-start;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 15px;
            color: #333;
        }
        .team-msg.others::after {
            content: ""; position: absolute; bottom: 0; left: -10px; width: 20px; height: 20px;
            background: radial-gradient(circle at top right, transparent, transparent 10px, white 10px);
        }

        .msg-sender { font-size: 0.75rem; font-weight: bold; color: #e67e22; margin-bottom: 4px; display: block; }
        .msg-time { font-size: 0.65rem; color: #999; text-align: left; margin-top: 5px; display: block; }

        .chat-input-area {
            background: #f0f0f0; padding: 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd;
        }
        .chat-input-area input { margin: 0; border-radius: 20px; border: none; padding: 12px 15px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .chat-input-area button {
            border-radius: 50%; width: 45px; height: 45px; padding: 0; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .chat-input-area button:hover { transform: scale(1.1); }

        .stickers-panel {
            height: 0; background: white; transition: 0.3s; overflow: hidden; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 0 10px;
        }
        .stickers-panel.open { height: 160px; padding: 10px; border-top: 1px solid #ccc; overflow-y: auto; }
        .sticker-item { cursor: pointer; border-radius: 5px; transition: 0.2s; text-align: center; height: 70px; display: flex; align-items: center; justify-content: center; background: #eee; }
        .sticker-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .sticker-item:hover { transform: scale(1.05); background: #ddd; }
        .sticker-msg-img { max-width: 150px; border-radius: 10px; }

        /* Shake Animation */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-screen { animation: shake 0.5s; animation-iteration-count: 1; }


        /* ========================================= */
        /*        CUSTOMER CHAT IMPROVED STYLES      */
        /* ========================================= */
        .chat-layout {
            display: flex;
            height: 75vh;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #d1d7db;
        }

        /* Sidebar (Chat List) */
        .chat-list {
            width: 300px;
            background: #fff;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .chat-list-header {
            padding: 15px;
            background: #f0f2f5;
            border-bottom: 1px solid #e0e0e0;
            font-weight: bold;
            color: #54656f;
        }

        .chat-users-scroll {
            flex: 1;
            overflow-y: auto;
        }

        .chat-user-item {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #f0f2f5;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        .chat-user-item:hover { background: #f5f6f6; }
        .chat-user-item.active { background: #e3f2fd; }

        .chat-avatar {
            width: 45px; height: 45px;
            background: #dfe6e9; color: #636e72;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem;
        }

        .chat-info { flex: 1; overflow: hidden; }
        .chat-name { font-weight: bold; font-size: 0.95rem; margin-bottom: 3px; color: #111b21; }
        .chat-preview { font-size: 0.8rem; color: #667781; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .unread-dot {
            width: 10px; height: 10px;
            background: var(--green);
            border-radius: 50%;
            position: absolute;
            left: 15px; top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 0 5px var(--green);
            display: none;
        }
        .chat-user-item.has-new .unread-dot { display: block; }
        .chat-user-item.has-new .chat-preview { color: var(--green); font-weight: bold; }

        /* Main Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #efeae2; /* WhatsApp BG */
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            position: relative;
        }

        .chat-header {
            padding: 10px 20px;
            background: #f0f2f5;
            border-bottom: 1px solid #d1d7db;
            display: flex;
            align-items: center;
            gap: 15px;
            height: 60px;
        }

        .chat-messages-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Chat Bubbles */
        .msg-bubble {
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .msg-me {
            background: #d9fdd3; /* Light Green */
            color: #111b21;
            align-self: flex-end;
            border-top-left-radius: 8px;
        }
        .msg-me::after { /* Tail */
            content: ""; position: absolute; top: 0; left: -8px; width: 0; height: 0;
            border-top: 10px solid #d9fdd3; border-left: 10px solid transparent; 
        }

        .msg-other {
            background: #ffffff;
            color: #111b21;
            align-self: flex-start;
            border-top-right-radius: 8px;
        }
        .msg-other::after { /* Tail */
            content: ""; position: absolute; top: 0; right: -8px; width: 0; height: 0;
            border-top: 10px solid #ffffff; border-right: 10px solid transparent; 
        }

        .msg-meta-time {
            font-size: 0.65rem;
            color: #667781;
            float: left;
            margin-right: -5px;
            margin-top: 5px;
            margin-left: 10px;
        }

        /* Input Area */
        .chat-footer {
            padding: 10px 15px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-footer input {
            margin: 0;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #fff;
            flex: 1;
            outline: none;
        }
        .chat-footer input:focus { border-color: #ccc; }

        .btn-send-icon {
            background: transparent; color: #54656f;
            border: none; font-size: 1.2rem; cursor: pointer;
            padding: 8px; transition: 0.2s;
        }
        .btn-send-icon:hover { color: var(--blue); transform: scale(1.1); }

        /* ========================================= */

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 500px; max-width: 90%; border-top: 5px solid var(--red); max-height: 80vh; overflow-y: auto; }
        
        /* Stats */
        .dash-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .dash-card { flex: 1; min-width: 150px; background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-val { font-size: 2rem; font-weight: bold; color: var(--blue); }
        
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .status-dot.online { background-color: #27ae60; box-shadow: 0 0 5px #27ae60; }
    </style>
</head>
<body>

    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3" loop></audio>
    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3"></audio>

    <div id="loginScreen">
        <h1>بوابة الموظفين - نجف</h1>
        <input type="text" id="username" placeholder="اسم الموظف">
        <input type="password" id="password" placeholder="كلمة المرور">
        <button id="loginBtn">دخول</button>
    </div>

    <div class="sidebar">
        <div style="text-align:center; margin-bottom:10px;">
            <img src="logo.png" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--red); background:white;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1996/1996068.png'">
        </div>
        <h2 style="text-align:center; margin-top:0;">
             <span id="adminNameDisplay"></span>
        </h2>
        <div class="menu-item active" onclick="nav('live-orders')"><i class="fas fa-bell"></i> الطلبات الحية</div>
        <div class="menu-item" onclick="nav('dashboard')"><i class="fas fa-chart-line"></i> السجل والإحصائيات</div>
        <div class="menu-item" onclick="nav('team-chat-section')"><i class="fas fa-users"></i> شات الفريق</div>
        
        <div class="menu-item" onclick="nav('manage-products')"><i class="fas fa-boxes"></i> إدارة المنتجات</div>
        
        <div class="admin-only">
            <div class="menu-item" onclick="nav('reports')"><i class="fas fa-file-invoice-dollar"></i> التقارير</div>
            <div class="menu-item" onclick="nav('products')"><i class="fas fa-plus-circle"></i> إضافة منتج جديد</div>
            <div class="menu-item" onclick="nav('users')"><i class="fas fa-users-cog"></i> الموظفين</div>
        </div>

        <div class="menu-item" id="chatMenuItem" onclick="nav('chat')">
            <i class="fas fa-comments"></i> شات العملاء 
            <span class="badge-counter" id="chatNotifyBadge">0</span>
        </div>
        <div class="menu-item" onclick="logoutStaff()" style="margin-top:auto; background:var(--red);"><i class="fas fa-sign-out-alt"></i> خروج</div>
    </div>

    <div class="main">

        <!-- 1. Live Orders -->
        <div id="live-orders" class="section active">
            <h3>متابعة الطلبات (Live)</h3>
            <div style="display: flex; gap: 20px; height: 70vh;">
                <div style="flex: 1; background: #e9ecef; border-radius: 10px; padding: 10px; overflow-y: auto;">
                    <div style="background:var(--red); color:white; padding:10px; text-align:center; border-radius:5px;">طلبات جديدة (مراجعة النطاق)</div>
                    <div id="newOrdersList"></div>
                </div>
                <div style="flex: 1; background: #e9ecef; border-radius: 10px; padding: 10px; overflow-y: auto;">
                    <div style="background:var(--blue); color:white; padding:10px; text-align:center; border-radius:5px;">جاري التحضير</div>
                    <div id="processingOrdersList"></div>
                </div>
            </div>
        </div>

        <!-- 2. Dashboard -->
        <div id="dashboard" class="section">
            <h3 id="dashTitle">سجل الطلبات</h3>
            <div class="form-box" style="padding:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <div style="flex:2; display:flex; align-items:center; gap:5px;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchPhoneInput" placeholder="بحث برقم الهاتف..." onkeyup="filterHistory()" style="margin:0;">
                </div>
                <div style="flex:1;">
                    <select id="filterStatus" onchange="filterHistory()" style="margin:0; padding:10px;">
                        <option value="all">كل الحالات</option>
                        <option value="completed">مكتمل</option>
                        <option value="cancelled">ملغي</option>
                        <option value="processing">جاري التحضير</option>
                    </select>
                </div>
            </div>
            <div class="dash-container admin-only" id="adminStatsBar">
                <div class="dash-card"><div>مبيعات اليوم</div><div id="todaySales" class="stat-val">0 ج</div></div>
                <div class="dash-card"><div>إجمالي الطلبات</div><div id="totalCount" class="stat-val" style="color:var(--blue);">0</div></div>
                <div class="dash-card"><div>أوردرات ملغية</div><div id="cancelledCount" class="stat-val" style="color:var(--red);">0</div></div>
                <div class="dash-card"><div>الأكثر مبيعاً</div><div id="bestSellerName" style="color:var(--green); font-weight:bold; font-size:1.2rem; margin-top:5px;">-</div></div>
            </div>
            <table class="users-table">
                <thead><tr><th>#</th><th>الوقت</th><th>العميل</th><th>الهاتف</th><th>المبلغ</th><th>الحالة</th><th>الموظف</th></tr></thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>

        <!-- 3. Reports -->
        <div id="reports" class="section">
            <div class="form-box">
                <h3>استخراج التقارير بالتاريخ</h3>
                <div style="display: flex; gap: 10px;">
                    <div style="flex:1">
                        <label>من تاريخ:</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div style="flex:1">
                        <label>إلى تاريخ:</label>
                        <input type="date" id="reportEndDate">
                    </div>
                </div>
                <button class="btn-blue" onclick="generateReport()">عرض التقرير</button>
                <button class="btn-blue" style="background:var(--green)" onclick="window.print()">طباعة</button>
            </div>
            <div id="reportResult" style="background:white; padding:20px; margin-top:20px; display:none;">
                <h3 style="text-align:center;">تقرير المبيعات</h3>
                <p style="text-align:center;">من <span id="repStartTxt"></span> إلى <span id="repEndTxt"></span></p>
                <table class="users-table"><thead><tr><th>الموظف</th><th>عدد الطلبات المكتملة</th><th>إجمالي المبيعات</th></tr></thead><tbody id="reportTableBody"></tbody></table>
                <h3 style="text-align:left; color:var(--blue)">الإجمالي الكلي: <span id="grandTotalRep">0</span> ج</h3>
            </div>
        </div>

        <!-- 4. TEAM CHAT (MODERN & FUN) -->
        <div id="team-chat-section" class="section">
            <h3>قهوة الموظفين ☕ (شات الفريق)</h3>
            <div class="team-chat-container">
                
                <!-- منطقة الرسائل -->
                <div class="team-chat-msgs" id="teamChatBox"></div>

                <!-- لوحة الستيكرز (مخفية افتراضياً) -->
                <div class="stickers-panel" id="stickersPanel">
                    <!-- ستيكرز مصرية مضحكة -->
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/m8WGPrQ3qVMAAAAM/cat-dance.gif')"><img src="https://media.tenor.com/m8WGPrQ3qVMAAAAM/cat-dance.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/NBX02q0mQf0AAAAM/laughing.gif')"><img src="https://media.tenor.com/NBX02q0mQf0AAAAM/laughing.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/y3x5kLdMhFMAAAAM/thumbs-up.gif')"><img src="https://media.tenor.com/y3x5kLdMhFMAAAAM/thumbs-up.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/Jj3lYlXqQWAAAAAM/shocked.gif')"><img src="https://media.tenor.com/Jj3lYlXqQWAAAAAM/shocked.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/pU5d5f_W1V4AAAAM/angry.gif')"><img src="https://media.tenor.com/pU5d5f_W1V4AAAAM/angry.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/2s9aV2-t6C0AAAAM/sad-cry.gif')"><img src="https://media.tenor.com/2s9aV2-t6C0AAAAM/sad-cry.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/K1C8tGjK1uEAAAAM/no-way.gif')"><img src="https://media.tenor.com/K1C8tGjK1uEAAAAM/no-way.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/3936611593321153406/watching-you-bird.gif')"><img src="https://media.tenor.com/3936611593321153406/watching-you-bird.gif" title="عصفورة"></div>
                </div>

                <!-- منطقة الأدوات والكتابة -->
                <div class="chat-input-area">
                    <button class="btn-warning" onclick="toggleStickers()" title="ستيكرز"><i class="far fa-smile-wink"></i></button>
                    <button class="btn-red" onclick="sendBuzz()" title="نكز (رجرجة الشاشة)"><i class="fas fa-bolt"></i></button>
                    <input type="text" id="teamMsgInput" placeholder="اكتب رسالة أو نكتة..." style="flex:1;" onkeypress="handleEnter(event)">
                    <button class="btn-blue" onclick="sendTeamMsg()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <!-- 5. Products -->
        <div id="products" class="section">
            <div class="form-box">
                <h3>إضافة منتج/عرض</h3>
                <label>الاسم</label><input type="text" id="prodName">
                <label>رابط الصورة</label><input type="text" id="prodImg">
                <label>التصنيف</label><select id="prodCatSelect"></select>
                <div style="background:#f0f8ff; padding:15px; margin:15px 0; border:1px solid #bddfff; border-radius:5px;">
                    <h4 style="margin-top:0; color:var(--blue);">الخيارات (مثل: كبير، وسط)</h4>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="vType" placeholder="الوصف (خبز كذا)" style="flex:2;">
                        <input type="text" id="vSize" placeholder="الحجم" style="flex:1;">
                        <input type="number" id="vPrice" placeholder="السعر" style="flex:1;">
                    </div>
                    <button class="btn-blue" style="background:var(--green); width:auto;" id="addVarBtn">إضافة خيار</button>
                    <div id="tempVarsDisplay" style="margin-top:15px;"></div>
                </div>
                <button class="btn-blue" style="width:100%" id="saveProdBtn">حفظ المنتج</button>
            </div>
            
            <!-- Category Management (Edit/Delete) -->
            <div class="form-box">
                <h3>إدارة التصنيفات</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="catMain" placeholder="اسم تصنيف جديد" style="margin:0;">
                    <button class="btn-blue" id="addCatBtn">إضافة</button>
                </div>
                <table class="users-table">
                    <thead><tr><th>التصنيف</th><th>إجراءات</th></tr></thead>
                    <tbody id="catManageList"></tbody>
                </table>
            </div>
        </div>

        <div id="manage-products" class="section">
            <h3>إدارة المنتجات</h3>
            <table class="users-table"><thead><tr><th>المنتج</th><th>الحالة</th><th>إجراء</th></tr></thead><tbody id="manageProdList"></tbody></table>
        </div>

        <!-- 6. Users (Modified for Online Status) -->
        <div id="users" class="section">
            <div class="form-box">
                <h3>إضافة موظف جديد</h3>
                <label>الاسم</label><input type="text" id="newUName">
                <label>الباسورد</label><input type="password" id="newUPass">
                <label>الصلاحية</label>
                <select id="newURole"><option value="receiver">متلقي طلبات</option><option value="admin">مدير</option></select>
                <button class="btn-blue" id="addUserBtn">إضافة</button>
            </div>
            <h3>قائمة الموظفين</h3>
            <table class="users-table"><thead><tr><th>الاسم والحالة</th><th>الصلاحية</th><th>إجراءات</th></tr></thead><tbody id="usersListBody"></tbody></table>
        </div>

        <!-- 7. Customer Chat (IMPROVED) -->
        <div id="chat" class="section">
            <div class="chat-layout">
                <!-- القائمة الجانبية -->
                <div class="chat-list">
                    <div class="chat-list-header">
                        <i class="fas fa-comments"></i> الرسائل الواردة
                    </div>
                    <div id="chatUsersList" class="chat-users-scroll">
                        <!-- سيتم ملء القائمة بالجافاسكربت -->
                    </div>
                </div>

                <!-- منطقة المحادثة -->
                <div class="chat-area">
                    <!-- رأس المحادثة -->
                    <div class="chat-header" id="chatHeaderArea" style="display:none;">
                        <div class="chat-avatar" style="background:var(--blue); color:white;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="chat-info">
                            <div class="chat-name" id="currentChatUser">اسم العميل</div>
                            <div style="font-size:0.75rem; color:green;">● متصل الآن</div>
                        </div>
                    </div>

                    <!-- الرسائل -->
                    <div id="adminChatBox" class="chat-messages-box">
                        <div style="text-align:center; margin-top:50px; color:#888;">
                            <i class="fas fa-paper-plane" style="font-size:3rem; margin-bottom:10px; opacity:0.3;"></i>
                            <br>اختر محادثة للبدء
                        </div>
                    </div>

                    <!-- مربع الكتابة -->
                    <div class="chat-footer" id="chatInputArea" style="display:none;">
                        <input type="text" id="adminChatInput" placeholder="اكتب رسالة للعميل..." onkeypress="handleAdminChatEnter(event)">
                        <button class="btn-send-icon" onclick="sendAdminMsg()">
                            <i class="fas fa-paper-plane" style="transform: rotate(180deg);"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal Order Details -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <h2 style="color:var(--blue); text-align:center;">تفاصيل الطلب</h2>
            <div id="modalBody"></div>
            <div id="cancelAlert" style="display:none; background:#fff3cd; color:#856404; padding:15px; margin:10px 0; border:1px solid #ffeeba; border-radius:5px;">
                <strong><i class="fas fa-exclamation-triangle"></i> تنبيه:</strong> العميل يطلب إلغاء هذا الأوردر!
                <div style="margin-top:5px;"><strong>السبب:</strong> <span id="cancelReasonText"></span></div>
            </div>
            <div id="modalActions" style="display:flex; justify-content:center; gap:10px; margin-top:20px;"></div>
            <button onclick="document.getElementById('orderModal').style.display='none'" style="width:100%; margin-top:10px; background:#ccc; color:black;">إغلاق</button>
        </div>
    </div>

    <!-- Modal User Edit -->
    <div class="modal" id="userEditModal">
        <div class="modal-content">
            <h2 style="color:var(--blue); text-align:center;">تعديل بيانات الموظف</h2>
            <label>الاسم الجديد</label>
            <input type="text" id="editUName">
            <label>الباسورد الجديد</label>
            <input type="text" id="editUPass">
            <label>الصلاحية</label>
            <select id="editURole">
                <option value="receiver">متلقي طلبات</option>
                <option value="admin">مدير</option>
            </select>
            <button class="btn-blue" onclick="saveUserEdit()">حفظ التعديلات</button>
            <button onclick="document.getElementById('userEditModal').style.display='none'" style="width:100%; margin-top:10px; background:#ccc; color:black;">إغلاق</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, update, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDi0582RlkH0GTFK6GIiLqZZOJn-zRi5vs",
          authDomain: "nagaf-e2810.firebaseapp.com",
          databaseURL: "https://nagaf-e2810-default-rtdb.firebaseio.com",
          projectId: "nagaf-e2810",
          storageBucket: "nagaf-e2810.firebasestorage.app",
          messagingSenderId: "1049815841886",
          appId: "1:1049815841886:web:a27ca703b985a4645bc8cf",
          measurementId: "G-QS18B2N7EZ"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentUser = JSON.parse(localStorage.getItem('nagaf_staff_user'));
        let activeChatUser = null;
        let tempVariants = [];
        let allOrders = {};
        let allUsersData = {};
        let chatsLoaded = false;
        let editingUserKey = null;
        let unreadChatCount = 0;

        // --- أصوات الهزار ---
        const sfxLaugh = new Audio('https://www.myinstants.com/media/sounds/laughing-crowd-1.mp3');
        const sfxApplaud = new Audio('https://www.myinstants.com/media/sounds/aplausos_2.mp3');
        const sfxBuzz = new Audio('https://www.myinstants.com/media/sounds/nudge-msn.mp3'); // صوت النكز
        const sfxRun = new Audio('https://www.myinstants.com/media/sounds/run-vine-sound-effect.mp3'); // صوت لما حد يقول عصفورة

        // Auto Login check
        if(currentUser) {
            loginSuccess(currentUser);
        }

        document.getElementById('loginBtn').addEventListener('click', () => {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if(!u || !p) return alert("أدخل البيانات");
            onValue(ref(db, 'users'), (snap) => {
                let found = null;
                let foundKey = null;
                const users = snap.val() || {};
                
                if(u === 'admin' && p === '123') found = {name: 'Admin', role: 'admin', key: 'static_admin'};
                else {
                    Object.entries(users).forEach(([k, user]) => { 
                        if(user.name === u && user.pass === p) { found = user; foundKey = k; }
                    });
                }
                
                if(found) {
                    found.key = foundKey || found.key;
                    currentUser = found;
                    localStorage.setItem('nagaf_staff_user', JSON.stringify(found));
                    loginSuccess(found);
                } else alert('خطأ في البيانات');
            }, {onlyOnce: true});
        });

        function loginSuccess(user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminNameDisplay').innerText = user.name;
            
            if(user.key && user.key !== 'static_admin') {
                const presenceRef = ref(db, 'users/' + user.key + '/online');
                set(presenceRef, true);
                onDisconnect(presenceRef).set(false);
            }

            if(user.role === 'receiver') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                document.getElementById('adminStatsBar').style.display = 'none';
            } else {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                document.getElementById('adminStatsBar').style.display = 'flex';
            }
            startSystem();
        }

        window.logoutStaff = function() {
            if(currentUser && currentUser.key) {
                update(ref(db, 'users/' + currentUser.key), {online: false}).then(() => {
                    localStorage.removeItem('nagaf_staff_user');
                    location.reload();
                });
            } else {
                localStorage.removeItem('nagaf_staff_user');
                location.reload();
            }
        }

        window.nav = function(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if(id === 'chat') {
                unreadChatCount = 0;
                updateChatBadge();
            }
        }

        function startSystem() {
            onValue(ref(db, 'orders'), (s) => { 
                allOrders = s.val() || {}; 
                renderOrders(allOrders); 
                updateStats(allOrders); 
            });
            onValue(ref(db, 'users'), (s) => {
                allUsersData = s.val() || {};
                renderUsers(allUsersData);
            });
            onValue(ref(db, 'products'), (s) => renderProdManage(s.val() || {}));
            onValue(ref(db, 'categories'), (s) => populateCats(s.val() || {}));
            onValue(ref(db, 'chats'), (s) => handleChatUpdate(s.val() || {}));
            onValue(ref(db, 'team_chat'), (s) => renderTeamChat(s.val() || {}));
        }

        // --- Modern Team Chat Logic ---
        function renderTeamChat(msgs) {
            const box = document.getElementById('teamChatBox');
            // Check if user is scrolled to bottom
            const isAtBottom = box.scrollHeight - box.scrollTop === box.clientHeight;
            
            box.innerHTML = '';
            
            // Sort messages
            const msgsList = Object.values(msgs).sort((a,b) => a.timestamp - b.timestamp);

            msgsList.forEach(m => {
                const isMe = m.sender === currentUser.name;
                
                // 1. معالجة النكز (Buzz)
                if (m.type === 'buzz') {
                    if (!m.played && Date.now() - m.timestamp < 2000) {
                        playBuzzEffect();
                        m.played = true; 
                    }
                    // لا تعرض نص "buzz" بل رسالة نظام صغيرة
                    box.innerHTML += `<div style="text-align:center; color:#999; font-size:0.8rem; margin:5px;">⚡ ${m.sender} عمل نكز للجميع ⚡</div>`;
                    return; 
                }

                // 2. تشغيل أصوات الكلمات المضحكة
                if (Date.now() - m.timestamp < 3000 && !isMe) {
                     checkFunnySounds(m.text);
                }

                const timeStr = new Date(m.timestamp).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});

                box.innerHTML += `
                    <div style="display:flex; flex-direction:column; ${isMe?'align-items:flex-end':'align-items:flex-start'}">
                        <div class="team-msg ${isMe ? 'mine' : 'others'}">
                            <span class="msg-sender">${m.sender}</span>
                            <div class="msg-content">${m.text}</div>
                            <span class="msg-time">${timeStr}</span>
                        </div>
                    </div>`;
            });
            
            box.scrollTop = box.scrollHeight;
        }

        // إرسال رسالة
        window.sendTeamMsg = function() {
            const inp = document.getElementById('teamMsgInput');
            const txt = inp.value.trim();
            if(!txt) return;
            
            push(ref(db, 'team_chat'), {
                sender: currentUser.name,
                text: txt,
                timestamp: Date.now(),
                type: 'text'
            });
            inp.value = '';
        }

        // إرسال ستيكر
        window.sendSticker = function(url) {
            const imgTag = `<img src="${url}" class="sticker-msg-img">`;
            push(ref(db, 'team_chat'), {
                sender: currentUser.name,
                text: imgTag,
                timestamp: Date.now(),
                type: 'sticker'
            });
            toggleStickers(); 
        }

        // إرسال نكز
        window.sendBuzz = function() {
            push(ref(db, 'team_chat'), {
                sender: currentUser.name,
                text: 'buzz',
                timestamp: Date.now(),
                type: 'buzz'
            });
        }

        // تأثير النكز
        function playBuzzEffect() {
            sfxBuzz.play().catch(()=>{});
            document.body.classList.add('shake-screen');
            setTimeout(() => {
                document.body.classList.remove('shake-screen');
            }, 500);
        }

        // أصوات الضحك والكلمات
        function checkFunnySounds(text) {
            if(!text) return;
            const t = text.toLowerCase();
            
            if(t.includes('هههه') || t.includes('haha') || t.includes('ضحك')) {
                sfxLaugh.currentTime = 0; sfxLaugh.play().catch(()=>{});
            }
            if(t.includes('عاش') || t.includes('بطل') || t.includes('الله ينور')) {
                sfxApplaud.currentTime = 0; sfxApplaud.play().catch(()=>{});
            }
            if(t.includes('عصفورة') || t.includes('المدير') || t.includes('جاي')) {
                sfxRun.currentTime = 0; sfxRun.play().catch(()=>{});
            }
        }

        window.toggleStickers = function() {
            document.getElementById('stickersPanel').classList.toggle('open');
        }

        window.handleEnter = function(e) {
            if(e.key === 'Enter') window.sendTeamMsg();
        }

        // --- Orders Logic ---
        function renderOrders(data) {
            const n = document.getElementById('newOrdersList'), p = document.getElementById('processingOrdersList');
            n.innerHTML = ''; p.innerHTML = '';
            let hasNewOrder = false;

            Object.entries(data).forEach(([k,o]) => {
                const c = `<div class="order-card ${o.cancelRequest?'cancel-requested':''}" onclick="openOrder('${k}')">
                    ${o.cancelRequest ? '<span class="cancel-badge">طلب إلغاء!</span>' : ''}
                    <h4>#${k.slice(-4)} - ${o.customerName}</h4>
                    <div>${o.phone}</div>
                    <div>${o.address}</div>
                    <div>${o.total} ج</div>
                </div>`;
                if(o.status === 'pending' || o.status === 'new') {
                    n.innerHTML += c;
                    if(!o.seenByAdmin) { hasNewOrder = true; update(ref(db,'orders/'+k),{seenByAdmin:true}); }
                } else if(o.status === 'processing') p.innerHTML += c;
            });

            const alarm = document.getElementById('alarmSound');
            if(hasNewOrder) {
                alarm.currentTime = 0;
                alarm.play().catch(()=>{});
            }
        }

        window.filterHistory = function() { updateStats(allOrders); }

        window.openOrder = function(k) {
            const alarm = document.getElementById('alarmSound');
            alarm.pause(); alarm.currentTime = 0;

            const o = allOrders[k]; if(!o) return;
            
            const items = (o.items || o.cart || []).map(i => {
                let noteHtml = '';
                if(i.note && i.note.trim() !== '') noteHtml = `<span class="item-note">⚠️ ${i.note}</span>`;
                return `<li>
                    <div style="margin-bottom:5px;">${i.name} ${i.variant ? `(${i.variant.bread} ${i.variant.size != 'موحد' ? '- ' + i.variant.size : ''})` : ''} - <strong>${i.variant ? i.variant.price : i.price} ج</strong></div>
                    ${noteHtml}
                </li>`;
            }).join('');
            
            let extraInfo = '';
            if(o.status === 'cancelled') {
                if(o.adminReason) extraInfo = `<div class="reason-box"><strong>تم الإلغاء بواسطة الإدارة:</strong><br>${o.adminReason}</div>`;
                else if(o.cancelReason) extraInfo = `<div class="reason-box"><strong>تم الإلغاء بطلب العميل:</strong><br>${o.cancelReason}</div>`;
            }

            document.getElementById('modalBody').innerHTML = `<p><strong>${o.customerName}</strong> (${o.phone})</p><p>${o.address}</p><hr><ul style="padding-right:20px; line-height:1.8;">${items}</ul>${extraInfo}<h3 style="color:var(--red)">${o.total} ج</h3>`;
            
            const act = document.getElementById('modalActions');
            const alertBox = document.getElementById('cancelAlert');
            act.innerHTML = ''; 

            if(o.cancelRequest) {
                alertBox.style.display = 'block';
                document.getElementById('cancelReasonText').innerText = o.cancelReason;
                act.innerHTML = `<button class="btn-red" onclick="rejectOrder('${k}')">✔ موافقة على الإلغاء</button><button class="btn-blue" onclick="rejCancelReq('${k}')">✖ رفض (استكمال الطلب)</button>`;
            } else {
                alertBox.style.display = 'none';
                if(o.status==='pending'||o.status==='new') act.innerHTML = `<button class="btn-blue" style="background:var(--green)" onclick="upStatus('${k}','processing')">قبول وتجهيز</button><button class="btn-red" onclick="rejectOrder('${k}')">رفض</button>`;
                else if(o.status==='processing') act.innerHTML = `<button class="btn-blue" onclick="upStatus('${k}','completed')">إنهاء</button>`;
            }
            document.getElementById('orderModal').style.display = 'block';
        }

        window.upStatus = (k,s) => { update(ref(db,'orders/'+k), {status:s, handledBy:currentUser.name}); document.getElementById('orderModal').style.display='none'; }
        window.rejectOrder = function(k) {
            let reason = prompt("اكتب سبب الرفض/الإلغاء:");
            if(reason) {
                update(ref(db,'orders/'+k), { status: 'cancelled', adminReason: reason, cancelRequest: false, handledBy:currentUser.name });
                document.getElementById('orderModal').style.display = 'none';
            }
        }
        window.rejCancelReq = (k) => { update(ref(db,'orders/'+k), {cancelRequest:false}); document.getElementById('orderModal').style.display='none'; }

        function updateStats(data) {
            let list = Object.entries(data).map(([k,v]) => ({...v, key: k})).reverse();
            if(document.getElementById('adminStatsBar').style.display !== 'none') {
                let comp = list.filter(o => o.status === 'completed');
                let totalSales = comp.reduce((s,o) => s + (parseInt(o.total)||0), 0);
                document.getElementById('todaySales').innerText = totalSales + ' ج';
                document.getElementById('totalCount').innerText = list.length; 
                document.getElementById('cancelledCount').innerText = list.filter(o => o.status === 'cancelled').length; 
            }
            const term = document.getElementById('searchPhoneInput').value;
            const statusFilter = document.getElementById('filterStatus').value;
            if(term) list = list.filter(o => o.phone.includes(term));
            if(statusFilter !== 'all') {
                if(statusFilter === 'processing') list = list.filter(o => o.status === 'pending' || o.status === 'new' || o.status === 'processing');
                else list = list.filter(o => o.status === statusFilter);
            }
            document.getElementById('historyTableBody').innerHTML = list.map(o => `
                <tr class="clickable-row" onclick="openOrder('${o.key}')">
                    <td>#${o.key.slice(-4)}</td>
                    <td>${new Date(o.timestamp).toLocaleTimeString('ar-EG')}</td>
                    <td>${o.customerName}</td>
                    <td>${o.phone}</td>
                    <td>${o.total} ج</td>
                    <td style="color:${o.status==='completed'?'green':(o.status==='cancelled'?'red':'orange')}">${o.status==='completed'?'مكتمل':(o.status==='cancelled'?'ملغي':'جاري')}</td>
                    <td>${o.handledBy||'-'}</td>
                </tr>`).join('');
        }

        window.generateReport = function() {
            const startVal = document.getElementById('reportStartDate').value;
            const endVal = document.getElementById('reportEndDate').value;
            if(!startVal || !endVal) return alert("الرجاء تحديد التاريخ من وإلى");
            const startDate = new Date(startVal).setHours(0,0,0,0);
            const endDate = new Date(endVal).setHours(23,59,59,999);
            const reportData = {};
            let grandTotal = 0;
            Object.values(allOrders).forEach(o => {
                if(o.status === 'completed') {
                    const d = new Date(o.timestamp).getTime();
                    if(d >= startDate && d <= endDate) {
                        const emp = o.handledBy || 'غير محدد';
                        if(!reportData[emp]) reportData[emp] = { count: 0, total: 0 };
                        reportData[emp].count += 1;
                        const amt = parseInt(o.total) || 0;
                        reportData[emp].total += amt;
                        grandTotal += amt;
                    }
                }
            });
            document.getElementById('repStartTxt').innerText = startVal;
            document.getElementById('repEndTxt').innerText = endVal;
            document.getElementById('reportResult').style.display = 'block';
            document.getElementById('grandTotalRep').innerText = grandTotal;
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            if(Object.keys(reportData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">لا توجد مبيعات في هذه الفترة</td></tr>';
            } else {
                Object.entries(reportData).forEach(([name, data]) => {
                    tbody.innerHTML += `<tr><td>${name}</td><td>${data.count}</td><td>${data.total} ج</td></tr>`;
                });
            }
        }

        document.getElementById('addUserBtn').addEventListener('click', () => { 
            let u=document.getElementById('newUName').value, p=document.getElementById('newUPass').value, r=document.getElementById('newURole').value; 
            if(u&&p){ push(ref(db,'users'),{name:u,pass:p,role:r}); alert('تمت الإضافة'); document.getElementById('newUName').value=''; document.getElementById('newUPass').value=''; }
        });

        function renderUsers(data) { 
            const t=document.getElementById('usersListBody'); 
            t.innerHTML=''; 
            Object.entries(data).forEach(([k,u])=>{ 
                if(u.role!=='customer') {
                    const onlineBadge = u.online 
                        ? `<span style="color:var(--green); font-weight:bold;"><span class="status-dot online"></span> متصل</span>` 
                        : `<span style="color:grey;"><span class="status-dot"></span> غير متصل</span>`;
                    t.innerHTML+=`
                    <tr>
                        <td style="text-align:right; padding-right:20px;">
                            <strong>${u.name}</strong><br>
                            ${onlineBadge}
                        </td>
                        <td>${u.role==='admin'?'مدير':'متلقي طلبات'}</td>
                        <td>
                            <button class="btn-warning" onclick="window.openEditUser('${k}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-red" onclick="window.delUser('${k}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`; 
                }
            }); 
        }

        window.delUser=(k)=>confirm('هل أنت متأكد من الحذف؟')&&remove(ref(db,'users/'+k));

        window.openEditUser = function(key) {
            const u = allUsersData[key]; if(!u) return;
            editingUserKey = key;
            document.getElementById('editUName').value = u.name;
            document.getElementById('editUPass').value = u.pass;
            document.getElementById('editURole').value = u.role;
            document.getElementById('userEditModal').style.display = 'flex';
        }

        window.saveUserEdit = function() {
            if(!editingUserKey) return;
            const n = document.getElementById('editUName').value;
            const p = document.getElementById('editUPass').value;
            const r = document.getElementById('editURole').value;
            if(n && p) {
                update(ref(db, 'users/' + editingUserKey), { name: n, pass: p, role: r })
                .then(() => {
                    alert("تم الحفظ"); document.getElementById('userEditModal').style.display = 'none'; editingUserKey = null;
                });
            }
        }

        function handleChatUpdate(chats) {
            renderChatList(chats);
            let newMsgFound = false;
            let currentUnread = 0;
            Object.values(chats).forEach(msgs => {
                const lastMsg = Object.values(msgs).pop();
                if(lastMsg && lastMsg.sender === 'customer') {
                    currentUnread++;
                    if(Date.now() - lastMsg.timestamp < 10000 && chatsLoaded) {
                        newMsgFound = true;
                    }
                }
            });
            unreadChatCount = currentUnread;
            updateChatBadge();
            if(!chatsLoaded) chatsLoaded = true;
            if(newMsgFound) {
                document.getElementById('msgSound').play().catch(()=>{});
            }
            if(activeChatUser) loadAdminChat(activeChatUser);
        }

        function updateChatBadge() {
            const badge = document.getElementById('chatNotifyBadge');
            const item = document.getElementById('chatMenuItem');
            const isChatActive = item.classList.contains('active');
            if(unreadChatCount > 0 && !isChatActive) {
                badge.style.display = 'inline-block';
                badge.innerText = unreadChatCount;
            } else {
                badge.style.display = 'none';
            }
        }

        // ===========================================
        //          UPDATED CHAT JS FUNCTIONS
        // ===========================================

        // 1. عرض قائمة العملاء
        function renderChatList(d) {
            const listContainer = document.getElementById('chatUsersList');
            listContainer.innerHTML = '';

            // تحويل الكائن لمصفوفة وترتيبها حسب أحدث رسالة
            const sortedChats = Object.entries(d).sort((a, b) => {
                const lastA = Object.values(a[1]).pop();
                const lastB = Object.values(b[1]).pop();
                return (lastB?.timestamp || 0) - (lastA?.timestamp || 0);
            });

            sortedChats.forEach(([phone, msgs]) => {
                const lastMsg = Object.values(msgs).pop();
                const isNew = lastMsg.sender === 'customer';
                const msgText = lastMsg.text.length > 25 ? lastMsg.text.substring(0, 25) + '...' : lastMsg.text;
                const time = new Date(lastMsg.timestamp).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
                const isActive = activeChatUser === phone ? 'active' : '';

                listContainer.innerHTML += `
                    <div class="chat-user-item ${isActive} ${isNew ? 'has-new' : ''}" onclick="window.loadChat('${phone}')">
                        <div class="chat-avatar"><i class="fas fa-user"></i></div>
                        <div class="chat-info">
                            <div class="chat-name">${phone}</div>
                            <div class="chat-preview">
                                ${isNew ? '<i class="fas fa-circle" style="font-size:0.5rem; margin-left:3px;"></i>' : ''}
                                ${lastMsg.sender === 'admin' ? '<i class="fas fa-check-double" style="font-size:0.7rem;"></i> ' : ''}
                                ${msgText}
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end;">
                            <span style="font-size:0.7rem; color:#999;">${time}</span>
                            <span class="unread-dot"></span>
                        </div>
                    </div>`;
            });
        }

        // 2. تحميل محادثة معينة
        window.loadChat = function(phone) {
            activeChatUser = phone;
            
            // إظهار الهيدر والإنبوت
            document.getElementById('chatHeaderArea').style.display = 'flex';
            document.getElementById('chatInputArea').style.display = 'flex';
            document.getElementById('currentChatUser').innerText = phone;
            
            // إعادة رسم القائمة لتحديث حالة الـ active
            onValue(ref(db, 'chats'), (s) => renderChatList(s.val() || {}), {onlyOnce:true});

            // جلب الرسائل
            onValue(ref(db, 'chats/' + phone), (snapshot) => {
                const msgs = snapshot.val() || {};
                const chatBox = document.getElementById('adminChatBox');
                chatBox.innerHTML = '';

                Object.values(msgs).forEach(m => {
                    const isMe = m.sender === 'admin';
                    const time = new Date(m.timestamp).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
                    
                    chatBox.innerHTML += `
                        <div class="msg-bubble ${isMe ? 'msg-me' : 'msg-other'}">
                            ${m.text}
                            <span class="msg-meta-time">${time}</span>
                        </div>
                    `;
                });

                // النزول لأسفل الشات تلقائياً
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        // 3. إرسال الرسالة
        window.sendAdminMsg = function() {
            const inp = document.getElementById('adminChatInput');
            const txt = inp.value.trim();
            if (txt && activeChatUser) {
                push(ref(db, 'chats/' + activeChatUser), {
                    sender: 'admin',
                    text: txt,
                    timestamp: Date.now()
                });
                inp.value = '';
                document.getElementById('msgSound').play().catch(()=>{}); // صوت عند الإرسال
            }
        }

        // دالة لزر الإنتر
        window.handleAdminChatEnter = function(e) {
            if(e.key === 'Enter') window.sendAdminMsg();
        }

        document.getElementById('addCatBtn').addEventListener('click', () => { 
            let n=document.getElementById('catMain').value; 
            if(n){ push(ref(db,'categories'),{name:n}); alert('تم'); document.getElementById('catMain').value=''; } 
        });

        function populateCats(data) { 
            const s=document.getElementById('prodCatSelect'); 
            const list = document.getElementById('catManageList');
            s.innerHTML='<option value="" disabled selected>اختر التصنيف</option>'; 
            list.innerHTML = '';
            Object.entries(data).forEach(([k, c])=>{
                s.innerHTML+=`<option value="${c.name}">${c.name}</option>`;
                list.innerHTML += `<tr><td><input type="text" value="${c.name}" id="cat-name-${k}" style="margin:0; text-align:center;"></td><td><button class="btn-blue" onclick="window.updateCat('${k}')">حفظ</button><button class="btn-red" onclick="window.delCat('${k}')">حذف</button></td></tr>`;
            }); 
        }

        window.updateCat = (k) => {
            const newVal = document.getElementById(`cat-name-${k}`).value;
            update(ref(db, 'categories/'+k), {name: newVal}).then(()=>alert('تم التعديل'));
        }
        window.delCat = (k) => {
            if(confirm('سيتم حذف التصنيف، متأكد؟')) remove(ref(db, 'categories/'+k));
        }

        document.getElementById('addVarBtn').addEventListener('click', () => { let b=document.getElementById('vType').value, s=document.getElementById('vSize').value, p=document.getElementById('vPrice').value; if(b && p) { tempVariants.push({bread:b,size:s||'موحد',price:parseInt(p)}); document.getElementById('tempVarsDisplay').innerHTML += `<span class="variant-tag" style="background:#eee; padding:5px; margin:2px; border-radius:3px;">${b} (${s||'موحد'}) : ${p}ج</span>`; document.getElementById('vType').value=''; document.getElementById('vSize').value=''; document.getElementById('vPrice').value=''; } });
        document.getElementById('saveProdBtn').addEventListener('click', () => { let n=document.getElementById('prodName').value, i=document.getElementById('prodImg').value, c=document.getElementById('prodCatSelect').value; if(n && tempVariants.length) { push(ref(db,'products'),{name:n,img:i,cat:c,variants:tempVariants,available:true}); alert('تم'); tempVariants=[]; document.getElementById('prodName').value=''; document.getElementById('tempVarsDisplay').innerHTML=''; } });
        function renderProdManage(data) { document.getElementById('manageProdList').innerHTML=Object.entries(data).map(([k,p])=>`<tr><td>${p.name}</td><td>${p.available?'متاح':'مغلق'}</td><td><button class="btn-blue" onclick="window.tog('${k}',${p.available})">تغيير</button><button class="btn-red" onclick="window.delP('${k}')">حذف</button></td></tr>`).join(''); }
        window.tog=(k,s)=>update(ref(db,'products/'+k),{available:!s}); window.delP=(k)=>confirm('حذف؟')&&remove(ref(db,'products/'+k));

    </script>
</body>
</html>
